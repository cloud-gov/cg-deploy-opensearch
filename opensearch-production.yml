instance_groups:
- name: opensearch_manager
  vm_type: m6i.xlarge
  instances: 3
  networks:
  - name: services

- name: opensearch_data
  instances: 12
  vm_type: r6i.2xlarge
  update:
    max_in_flight: 2
    canaries: 2

- name: opensearch_dashboards
  vm_type: t3.xlarge
  instances: 2

- name: archiver
  instances: 3
  vm_type: m6i.large

- name: ingestor
  instances: 7
  vm_type: r6i.xlarge.logsearch.ingestor

- name: maintenance
  vm_type: t3.large
  instances: 1
  jobs:
  - name: upload_opensearch_config
    release: opensearch
    properties:
      opensearch_config:
        rollover_document_size: 600gb
        rollover_index_age: 1d
        shard_count: 12
  - name: curator
    release: opensearch
    properties:
      curator:
        purge_logs:
          retention_period: 365

- name: ingestor_logsearch_september
  instances: 1
  jobs:
  - name: bpm
    release: bpm
  - name: opensearch
    release: opensearch
    consumes: *consumes-opensearch-manager
    properties:
      opensearch:
        heap_size: 1G
        http_host: 127.0.0.1
        jvm_options:
        - -Dlog4j2.formatMsgNoLookups=true
  - consumes: *consumes-opensearch-manager
    name: ingestor_logsearch
    properties:
      logstash:
        jvm_options:
        - -Dlog4j2.formatMsgNoLookups=true
        queue:
          max_bytes: 40gb
      logstash_ingestor:
        syslog_tls:
          port: 6972
          ssl_cert: ((ingestor_syslog_server_tls.certificate))
          ssl_key: ((ingestor_syslog_server_tls.private_key))
      logstash_parser:
        inputs:
          - plugin: s3
            options:
              bucket: (( grab terraform_outputs.logsearch_archive_bucket_name ))
              region: (( grab terraform_outputs.vpc_region ))
              prefix: 2024/09
              type: syslog
        deployment_dictionary:
        - /var/vcap/jobs/deployment_lookup_config/config/deployment_lookup.yml
        filters:
        - logs-for-cf: /var/vcap/packages/logsearch-filters/logstash-filters-default.conf
        opensearch:
          data_hosts:
          - localhost
          index: "logs-app-%{+YYYY.MM.dd}"
          index_type: '%{@type}'
          ssl:
            ca: ((opensearch_node.ca))
            certificate: ((logstash.certificate))
            private_key: ((logstash.private_key))
    provides:
      ingestor:
        as: ingestor_logsearch_link
    release: opensearch
  - name: deployment_lookup_config
    release: opensearch
  vm_type: r6i.xlarge.logsearch.ingestor
  networks:
  - name: services
  persistent_disk_type: logs_opensearch_ingestor
  stemcell: default
  azs:
  - z1
  vm_extensions:
  - logs-opensearch-ingestor-profile
  - 50GB_ephemeral_disk

addons:
- name: bosh-dns-aliases
  jobs:
  - name: bosh-dns-aliases
    release: bosh-dns-aliases
    properties:
      aliases:
      - domain: nats.service.cf.internal
        targets:
        - deployment: cf-production
          domain: bosh
          instance_group: nats
          network: default
          query: '*'
